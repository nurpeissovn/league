<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>League Tracker</title>
<style>
body { font-family: Arial; background: #f0f4ff; padding: 20px; position: relative; overflow-x: hidden; }
h1 { text-align: center; }
.card { background: white; padding: 15px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
input, select { padding: 5px; margin: 5px; }
button { padding: 6px 12px; margin-left: 5px; border-radius: 6px; border: none; background: #2563eb; color:white; cursor:pointer;}
button:hover { background: #1e40af; }
table { width: 100%; border-collapse: collapse; margin-top: 10px;}
th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
th { background: #f9f9f9; }
.particle {
    position: fixed;
    width: 6px;
    height: 6px;
    background: orange;
    border-radius: 50%;
    pointer-events: none;
    animation: explode 700ms ease-out forwards;
}
@keyframes explode {
    from { transform: translate(0, 0) scale(1); opacity: 1; }
    to { transform: translate(var(--x), var(--y)) scale(0.5); opacity: 0; }
}
.done-text {
    position: fixed;
    top: 150px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    color: green;
    font-weight: bold;
}
.tables-container {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}
.tables-container .card {
  flex: 1;
  min-width: 300px;
}
</style>
</head>
<body>
<h1>‚öΩ League Tracker</h1>

<div class="card">
    <h2>Enter Match Result</h2>
    <div class="flex-row">
      <div class="input-group">
        <label>Team 1:</label>
        <select id="team1"></select>
        <input id="score1" type="number" value="0" min="0">
      </div>
      <div class="input-group">
        <label>Team 2:</label>
        <select id="team2"></select>
        <input id="score2" type="number" value="0" min="0">
      </div>
      <button onclick="handleSubmit()">Submit Match</button>
      <button onclick="undoMatch()" style="background: #dc2626;">Undo Last Match</button>
    </div>
  </div>
  
  <div class="card">
    <h2>Add Player Statistics</h2>
    <div class="flex-row">
      <div class="input-group">
        <label>Player:</label>
        <select id="playerSelectInput"></select>
      </div>
      <div class="input-group">
        <label>Goals ‚öΩ:</label>
        <input id="goals" type="number" value="0" min="0">
      </div>
      <div class="input-group">
        <label>Assists üéØ:</label>
        <input id="assists" type="number" value="0" min="0">
      </div>
      <button onclick="addPlayerStats()">Add Stats</button>
    </div>
  </div>

  <div class="tables-container">
    <div class="card" style="flex:1">
      <h2>üë§ Player Statistics</h2>
      <table id="playerTable">
        <thead>
          <tr><th>Player</th><th>Team</th><th>Goals</th><th>Assists</th><th>Total (G+A)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  
    <div class="card" style="flex:1">
      <h2>üèüÔ∏è Team Statistics</h2>
      <table id="teamTable">
        <thead>
          <tr><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<div class="card">
<h2>üìú Match History</h2>
<table id="historyTable">
<thead><tr><th>Match</th><th>Score</th></tr></thead>
<tbody></tbody>
</table>
</div>

<script>
const teams = {}; // { teamName: { id, P, W, D, L, GF, GA, GD, Pts } }
const players = {}; // { playerName: { team, teamId, goals, assists } }
const history = []; // [{ t1, s1, t2, s2, matchId }]
let teamIdToName = {}; // { id: name }
let lastTeam1 = null;
let lastTeam2 = null;
let lastPlayer = null;

async function fetchWithRetry(url, retries = 3, delay = 1000) {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(url);
      if (response.ok) {
        return response;
      }
      console.warn(`Attempt ${i + 1} failed for ${url}: ${response.status}`);
    } catch (error) {
      console.warn(`Attempt ${i + 1} error for ${url}:`, error);
    }
    if (i < retries - 1) {
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  throw new Error(`Failed to fetch ${url} after ${retries} attempts`);
}

async function loadAllData() {
  const statusEl = document.getElementById("loadingStatus");
  statusEl.textContent = "Loading...";
  statusEl.style.color = "#666";
  
  try {
    // 1) Load teams with retry
    const resTeams = await fetchWithRetry("/api/list-teams");
    const dbTeams = await resTeams.json(); // [{id, name}]
    console.log("Loaded teams:", dbTeams);
    
    if (!Array.isArray(dbTeams)) {
      console.error("Teams response is not an array:", dbTeams);
      throw new Error("Invalid teams response format");
    }
    
    if (dbTeams.length === 0) {
      console.log("No teams in database yet. Please add teams in registration page.");
      statusEl.textContent = "No teams yet. Go to registration page to add teams.";
      statusEl.style.color = "#f59e0b";
      render(); // Render empty tables
      return;
    }
    
    for (const t of dbTeams) {
      teams[t.name] = { id: t.id, P:0, W:0, D:0, L:0, GF:0, GA:0, GD:0, Pts:0 };
      teamIdToName[t.id] = t.name;
    }

    // 2) Load players with retry
    try {
      const resP = await fetchWithRetry("/api/players");
      const dbPlayers = await resP.json(); // [{name, team_id, goals, assists}]
      console.log("Loaded players:", dbPlayers);
      for (const p of dbPlayers) {
        const teamName = teamIdToName[p.team_id] || "Unknown";
        if (!teams[teamName]) {
          teams[teamName] = { id: p.team_id, P:0, W:0, D:0, L:0, GF:0, GA:0, GD:0, Pts:0 };
        }
        players[p.name] = { 
          team: teamName, 
          teamId: p.team_id,
          goals: p.goals, 
          assists: p.assists 
        };
      }
    } catch (e) {
      console.warn("No players loaded yet:", e);
    }

    // 3) Load matches and recompute standings with retry
    try {
      const resM = await fetchWithRetry("/api/matches");
      const dbMatches = await resM.json(); // [{team1_id, team2_id, score1, score2, played_at}]
      console.log("Loaded matches:", dbMatches);
      for (const m of dbMatches) {
        const t1 = teamIdToName[m.team1_id];
        const t2 = teamIdToName[m.team2_id];
        if (!t1 || !t2) continue;
        
        // Ensure teams exist
        for (const t of [t1, t2]) {
          if (!teams[t]) teams[t] = { id: m[`team${t===t1?1:2}_id`], P:0, W:0, D:0, L:0, GF:0, GA:0, GD:0, Pts:0 };
        }
        
        // Update standings
        teams[t1].P++; teams[t2].P++;
        teams[t1].GF += m.score1; teams[t1].GA += m.score2;
        teams[t2].GF += m.score2; teams[t2].GA += m.score1;
        
        if (m.score1 > m.score2) {
          teams[t1].W++; teams[t2].L++; teams[t1].Pts += 3;
        } else if (m.score1 < m.score2) {
          teams[t2].W++; teams[t1].L++; teams[t2].Pts += 3;
        } else {
          teams[t1].D++; teams[t2].D++; teams[t1].Pts++; teams[t2].Pts++;
        }
        
        teams[t1].GD = teams[t1].GF - teams[t1].GA;
        teams[t2].GD = teams[t2].GF - teams[t2].GA;
        
        // Add to history
        history.push({ t1, s1: m.score1, t2, s2: m.score2, matchId: m.id });
      }
    } catch (e) {
      console.warn("No matches loaded yet:", e);
    }

    console.log("Data loaded successfully");
    statusEl.textContent = "‚úÖ Data loaded successfully!";
    statusEl.style.color = "#16a34a";
    render();
  } catch (e) {
    console.error("Failed to load data:", e);
    statusEl.textContent = "‚ùå Failed to load data. Click refresh to retry.";
    statusEl.style.color = "#dc2626";
    alert("Failed to load data from database. Error: " + e.message + "\n\nPlease check:\n1. Is your server running?\n2. Is DATABASE_URL set correctly?\n3. Try refreshing the page\n4. Check browser console for details");
  }
}

async function handleSubmit() {
  const t1 = document.getElementById("team1").value;
  const t2 = document.getElementById("team2").value;
  const s1 = parseInt(document.getElementById("score1").value) || 0;
  const s2 = parseInt(document.getElementById("score2").value) || 0;

  if (t1 === t2) {
    alert("Team cannot play itself!");
    return;
  }

  try {
    const res = await fetch("/api/add-match", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        team1_id: teams[t1].id,
        team2_id: teams[t2].id,
        score1: s1,
        score2: s2
      })
    });

    if (!res.ok) {
      alert("Failed to save match");
      return;
    }

    const data = await res.json();
    const matchId = data.id; // Get the match ID from response

    // Update local state
    teams[t1].P++; teams[t2].P++;
    teams[t1].GF += s1; teams[t1].GA += s2;
    teams[t2].GF += s2; teams[t2].GA += s1;

    if (s1 > s2) {
      teams[t1].W++; teams[t2].L++; teams[t1].Pts += 3;
    } else if (s1 < s2) {
      teams[t2].W++; teams[t1].L++; teams[t2].Pts += 3;
    } else {
      teams[t1].D++; teams[t2].D++; teams[t1].Pts++; teams[t2].Pts++;
    }

    teams[t1].GD = teams[t1].GF - teams[t1].GA;
    teams[t2].GD = teams[t2].GF - teams[t2].GA;

    history.push({ t1, s1, t2, s2, matchId });
    
    // Remember selected teams
    lastTeam1 = t1;
    lastTeam2 = t2;
    
    render();
    fireworks("Done ‚úÖ");
  } catch (e) {
    console.error(e);
    alert("Network error while saving match");
  }
}

async function addPlayerStats() {
  const playerName = document.getElementById("playerSelectInput").value;
  const goals = parseInt(document.getElementById("goals").value) || 0;
  const assists = parseInt(document.getElementById("assists").value) || 0;

  if (!playerName) {
    alert("Please select a player");
    return;
  }

  const player = players[playerName];
  const newGoals = player.goals + goals;
  const newAssists = player.assists + assists;

  try {
    const res = await fetch("/api/add-player", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: playerName,
        team_id: player.teamId,
        goals: newGoals,
        assists: newAssists
      })
    });

    if (!res.ok) {
      alert("Failed to update player stats");
      return;
    }

    player.goals = newGoals;
    player.assists = newAssists;
    
    // Remember selected player
    lastPlayer = playerName;
    
    document.getElementById("goals").value = "0";
    document.getElementById("assists").value = "0";
    
    render();
    fireworks("Done ‚úÖ");
  } catch (e) {
    console.error(e);
    alert("Network error while updating player stats");
  }
}

function fireworks(text = "") {
  const centerX = window.innerWidth / 2;
  const centerY = 150;

  for (let i = 0; i < 25; i++) {
    const p = document.createElement("div");
    p.className = "particle";

    const angle = Math.random() * 2 * Math.PI;
    const distance = 100 + Math.random() * 50;
    const x = Math.cos(angle) * distance;
    const y = Math.sin(angle) * distance;

    p.style.left = `${centerX}px`;
    p.style.top = `${centerY}px`;
    p.style.setProperty("--x", `${x}px`);
    p.style.setProperty("--y", `${y}px`);

    document.body.appendChild(p);
    setTimeout(() => p.remove(), 1300);
  }

  if (text) {
    const t = document.createElement("div");
    t.className = "done-text";
    t.textContent = text;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2000);
  }
}

function render() {
  // Teams dropdown - remember last selections
  const t1 = document.getElementById("team1");
  const t2 = document.getElementById("team2");
  t1.innerHTML = "";
  t2.innerHTML = "";
  for (const t in teams) {
    t1.innerHTML += `<option value="${t}" ${t === lastTeam1 ? "selected" : ""}>${t}</option>`;
    t2.innerHTML += `<option value="${t}" ${t === lastTeam2 ? "selected" : ""}>${t}</option>`;
  }

  // Players dropdown - remember last selection
  const sel = document.getElementById("playerSelectInput");
  sel.innerHTML = "";
  for (const p in players) {
    sel.innerHTML += `<option value="${p}" ${p === lastPlayer ? "selected" : ""}>${p} (${players[p].team})</option>`;
  }

  // Player table - sorted by total (G+A), then by goals as tiebreaker
  const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => {
    const totalA = a.goals + a.assists;
    const totalB = b.goals + b.assists;
    if (totalB !== totalA) return totalB - totalA;
    return b.goals - a.goals; // Tiebreaker: more goals first
  });

  let playerRows = "";
  sortedPlayers.forEach(([name, p], index) => {
    const total = p.goals + p.assists;
    let bg = "";
    if (index === 0) bg = "background-color: gold; font-weight:bold;";
    else if (index === 1) bg = "background-color: silver; font-weight:bold;";
    else if (index === 2) bg = "background-color: #cd7f32; font-weight:bold;";
    playerRows += `<tr style="${bg}"><td>${name}</td><td>${p.team}</td><td>‚öΩ ${p.goals}</td><td>üéØ ${p.assists}</td><td>${total}</td></tr>`;
  });
  document.querySelector("#playerTable tbody").innerHTML = playerRows;

  // Team table - sorted by points, then goal difference
  const sortedTeams = Object.entries(teams).sort(([, a], [, b]) => {
    if (b.Pts !== a.Pts) return b.Pts - a.Pts;
    return b.GD - a.GD;
  });

  let teamRows = "";
  sortedTeams.forEach(([t, x]) => {
    teamRows += `<tr>
      <td>${t}</td><td>${x.P}</td><td>${x.W}</td><td>${x.D}</td><td>${x.L}</td>
      <td>${x.GF}</td><td>${x.GA}</td><td>${x.GD}</td><td>${x.Pts}</td>
    </tr>`;
  });
  document.querySelector("#teamTable tbody").innerHTML = teamRows;

  // Match history
  let hist = "";
  history.forEach((m, i) => {
    hist += `<tr><td>Match ${i + 1}</td><td>${m.t1} ${m.s1} - ${m.s2} ${m.t2}</td></tr>`;
  });
  document.querySelector("#historyTable tbody").innerHTML = hist;
}

// Load all data on page load
loadAllData();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scoreboard — Daily Period</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:1000px;margin:24px auto;padding:0 12px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f4f4f4}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:#555;font-size:0.9em}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#efefef}
  </style>
</head>
<body>
  <h1>Текущий зачёт (по дню)</h1>
  <div class="row">
    <label for="period">Дата периода:</label>
    <input id="period" type="date" />
    <button id="apply">Показать</button>
    <span id="periodInfo" class="muted"></span>
  </div>

  <h2>Игроки (гол+пас)</h2>
  <table id="tblPlayers">
    <thead>
      <tr><th>#</th><th>Игрок</th><th>Команда</th><th>Голы</th><th>Пасы</th><th>Сумма</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Матчи</h2>
  <table id="tblMatches">
    <thead>
      <tr><th>#</th><th>Время</th><th>Команда 1</th><th>Счёт</th><th>Команда 2</th><th>Действие</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const qs = s=>document.querySelector(s);
    const periodEl = qs('#period');
    periodEl.value = new Date().toISOString().slice(0,10);

    async function getJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function postJSON(url, body){ const r=await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

    async function loadPeriodInfo(){
      try {
        const data = await getJSON('/api/current-period');
        if(!data.period){
          qs('#periodInfo').textContent = 'Активный период не найден';
          return;
        }
        const start = new Date(data.period.start_time).toLocaleString();
        const end = data.period.end_time ? new Date(data.period.end_time).toLocaleString() : '—';
        qs('#periodInfo').textContent = `Текущий период: ${data.period.name} (${start} — ${end})`;
      } catch(err){
        console.error(err);
        qs('#periodInfo').textContent = 'Не удалось получить данные периода';
      }
    }

    async function loadPlayers(){
      const [players, teams] = await Promise.all([
        getJSON('/api/players'),
        getJSON('/api/list-teams')
      ]);
      const teamById = new Map(teams.map(t=>[t.id, t]));
      const tbody = qs('#tblPlayers tbody'); tbody.innerHTML = '';
      players.forEach((pl, i)=>{
        const tr = document.createElement('tr');
        const sum = (pl.goals||0) + (pl.assists||0);
        tr.innerHTML = `<td>${i+1}</td>
                        <td>${pl.name}</td>
                        <td><span class="pill">${teamById.get(pl.team_id)?.name||'-'}</span></td>
                        <td>${pl.goals||0}</td>
                        <td>${pl.assists||0}</td>
                        <td><b>${sum}</b></td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadMatches(){
      const [matches, teams] = await Promise.all([
        getJSON('/api/matches'),
        getJSON('/api/list-teams')
      ]);
      const teamById = new Map(teams.map(t=>[t.id, t]));
      const tbody = qs('#tblMatches tbody'); tbody.innerHTML='';
      matches.forEach((m, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td>
                        <td>${new Date(m.played_at || m.played).toLocaleString()}</td>
                        <td>${teamById.get(m.team1_id)?.name||m.team1_id}</td>
                        <td>${m.score1} : ${m.score2}</td>
                        <td>${teamById.get(m.team2_id)?.name||m.team2_id}</td>
                        <td><button data-id="${m.id}">Удалить</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!confirm('Удалить матч?')) return;
          try {
            await postJSON('/api/delete-match', {id:Number(btn.dataset.id)});
            await loadMatches();
          } catch(err){
            alert(err.message||'Не удалось удалить матч');
          }
        });
      });
    }

    qs('#apply').addEventListener('click', async ()=>{
      await Promise.all([loadPeriodInfo(), loadPlayers(), loadMatches()]);
    });

    // initial
    loadPeriodInfo().then(()=>Promise.all([loadPlayers(), loadMatches()]));
  </script>
</body>
</html>

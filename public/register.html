
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register — Daily Period</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}
    h2{margin-top:24px}
    fieldset{margin:12px 0;padding:12px;border-radius:8px}
    label{display:block;margin:6px 0 4px}
    input,select,button{padding:8px;border-radius:6px;border:1px solid #ccc}
    button{cursor:pointer}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{color:#555;font-size:0.9em}
  </style>
</head>
<body>
  <h1>Регистрация (суточные периоды)</h1>
  <p class="muted">По умолчанию — текущий день (Asia/Almaty). Для просмотра/записи в архив можно выбрать дату.</p>

  <fieldset>
    <legend>Период</legend>
    <div class="row">
      <label for="period">Дата периода (YYYY-MM-DD)</label>
      <input id="period" type="date" />
      <button id="applyPeriod">Применить</button>
      <span id="periodInfo" class="muted"></span>
    </div>
  </fieldset>

  <fieldset>
    <legend>Команда</legend>
    <div class="row">
      <input id="teamName" placeholder="Название команды" />
      <button id="addTeam">Добавить</button>
    </div>
    <div id="teamsList" class="muted"></div>
  </fieldset>

  <fieldset>
    <legend>Игрок</legend>
    <div class="row">
      <select id="playerTeam"></select>
      <input id="playerName" placeholder="ФИО игрока" />
      <input id="playerGoals" type="number" value="0" style="width:90px" />
      <input id="playerAssists" type="number" value="0" style="width:90px" />
      <button id="addPlayer">Добавить</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Матч</legend>
    <div class="row">
      <select id="mTeam1"></select>
      <input id="mScore1" type="number" value="0" style="width:70px" />
      <span>—</span>
      <input id="mScore2" type="number" value="0" style="width:70px" />
      <select id="mTeam2"></select>
      <button id="addMatch">Добавить</button>
    </div>
  </fieldset>

  <script>
    const qs = (s)=>document.querySelector(s);
    const periodInput = qs('#period');
    const periodInfo = qs('#periodInfo');
    const currentDateISO = new Date().toISOString().slice(0,10);
    periodInput.value = currentDateISO;

    async function refreshPeriodInfo(){
      try {
        const res = await fetch('/api/current-period');
        if(!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if(!data.period){
          periodInfo.textContent = 'Активный период не найден';
          return;
        }
        const start = new Date(data.period.start_time).toLocaleString();
        const end = data.period.end_time ? new Date(data.period.end_time).toLocaleString() : 'идёт';
        const remaining = typeof data.remaining_hours === 'number' ? data.remaining_hours.toFixed(1) : '?';
        periodInfo.textContent = `Текущий период: ${data.period.name} (${start} — ${end}), осталось ~${remaining} ч.`;
      } catch(err){
        console.error(err);
        periodInfo.textContent = 'Не удалось получить активный период';
      }
    }

    async function loadTeams(){
      const res = await fetch('/api/list-teams');
      const data = await res.json();
      qs('#teamsList').textContent = `Команд: ${data.length}`;
      const sel = qs('#playerTeam');
      const m1 = qs('#mTeam1');
      const m2 = qs('#mTeam2');
      sel.innerHTML = '';
      m1.innerHTML = '';
      m2.innerHTML = '';
      for(const t of data){
        const o1 = document.createElement('option'); o1.value=t.id; o1.textContent=t.name;
        const o2 = document.createElement('option'); o2.value=t.id; o2.textContent=t.name;
        const o3 = document.createElement('option'); o3.value=t.id; o3.textContent=t.name;
        sel.appendChild(o1); m1.appendChild(o2); m2.appendChild(o3);
      }
    }

    qs('#applyPeriod').addEventListener('click', async ()=>{
      await refreshPeriodInfo();
      await loadTeams();
    });

    qs('#addTeam').addEventListener('click', async ()=>{
      const name = qs('#teamName').value.trim();
      if(!name) return alert('Введите название команды');
      const res = await fetch('/api/add-team', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name})
      });
      if(!res.ok){ alert(await res.text()); return; }
      qs('#teamName').value='';
      await loadTeams();
    });

    qs('#addPlayer').addEventListener('click', async ()=>{
      const name = qs('#playerName').value.trim();
      const team_id = Number(qs('#playerTeam').value);
      const goals = Number(qs('#playerGoals').value||0);
      const assists = Number(qs('#playerAssists').value||0);
      if(!name || !team_id) return alert('Заполните игрока и команду');
      const res = await fetch('/api/add-player', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, team_id, goals, assists})
      });
      if(!res.ok){ alert(await res.text()); return; }
      qs('#playerName').value=''; qs('#playerGoals').value=0; qs('#playerAssists').value=0;
      alert('Игрок сохранён');
    });

    qs('#addMatch').addEventListener('click', async ()=>{
      const team1_id = Number(qs('#mTeam1').value);
      const team2_id = Number(qs('#mTeam2').value);
      const score1 = Number(qs('#mScore1').value||0);
      const score2 = Number(qs('#mScore2').value||0);
      if(!team1_id || !team2_id || team1_id===team2_id) return alert('Выберите две разные команды');
      const res = await fetch('/api/add-match', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({team1_id, team2_id, score1, score2})
      });
      if(!res.ok){ alert(await res.text()); return; }
      alert('Матч добавлен');
    });

    // initial
    refreshPeriodInfo().then(loadTeams);
  </script>
</body>
</html>
